
```{r setup}
list.of.packages <- c("stringr", "knitr", "RTextTools", "data.table")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)
rm(list.of.packages, new.packages)

opts_chunk$set(echo=TRUE,
               cache=TRUE, autodep=TRUE,
               message=FALSE, warning=FALSE)
options(scipen = 1, digits = 4)
```

```{r}
clean_text = function(text){
  text = str_replace_all(text, pattern='\n', replacement=' ')
  text = tolower(str_replace_all(text, '[^[A-Za-z ][:space:]]', replacement=' '))
  return(text)
}
```

```{r}
train = fread("data/train.csv")
train$comment_text = clean_text(train$comment_text)
docterm.matrix = create_matrix(train$comment_text, removeSparseTerms=.999)
label.names = colnames(train)[3:8]
```

```{r}
model.fname = 'svm_models.r'

if(!file.exists(model.fname)){
  train = train[,..label.names] #memory
  TRAIN.SAMPLE.SIZE = 10000
  TEST.SAMPLE.SIZE = 2000
  
  
  train.sample = sample(1:nrow(train), TRAIN.SAMPLE.SIZE+TEST.SAMPLE.SIZE, replace=F)
  train = train[train.sample]
  
  models = vector(mode='list', length=length(label.names))
  names(models)=label.names
  
  for(i in 1:length(models)){
    label.name = label.names[i]
    print(label.name)
    
    train_indices = 
    
    container = create_container(docterm.matrix, labels=train$label.name, trainSize = 1:TRAIN.SAMPLE.SIZE, testSize = (TRAIN.SAMPLE.SIZE + 1):(TRAIN.SAMPLE.SIZE + 1 + TEST.SAMPLE.SIZE), virgin=FALSE)
    models[[i]] = train_models(container, algorithms=c("SVM"), kernel="linear", cost=1)
  }
  rm(train, i, label.name)
  
  save(models, file=model.fname)
}
```

```{r}
load('models.r')
testdata = fread('data/test.csv')
testdata$comment_text = clean_text(testdata$comment_text)
testdata = testdata[1:5000,]
testdata.splitted = split(testdata, (seq(nrow(testdata))-1) %/% 1000) 
rm(testdata)

#trace("create_matrix", edit=T) #'Acronym' -> 'acronym'

probs = vector(mode='list', length=length(label.names))
names(probs) = label.names
for(i in 1:length(models)){
  print(label.names[i])
  model = models[[i]]
  chunk_probs = vector(mode='list', length=length(testdata.splitted))
  for(j in 1:length(testdata.splitted)){
    print(j)
    testdata.chunk = testdata.splitted[[j]]
    pred.matrix = create_matrix(testdata.chunk$comment_text, originalMatrix=docterm.matrix)
    predSize = nrow(testdata.chunk);
    predContainer = create_container(pred.matrix, rep(0,predSize), testSize=1:predSize, virgin=FALSE)
    results = classify_models(predContainer, model)
    chunk_probs[[j]] = ifelse(results$SVM_LABEL==1, results$SVM_PROB, 1-results$SVM_PROB)
  }
  final_result = data.frame(unlist(chunk_probs))
  colnames(final_result) = c('prob')
  write.table(final_result, file=paste0(label.names[i], '_results.csv'), quote=FALSE, sep=',', row.names=FALSE))
  probs[[i]] = unlist(chunk_probs)
}
```

```{r}
allprobs = as.data.table(do.call(cbind, probs))
allprobs$id = data$id[1:5000]
setcolorder(allprobs, c('id', label.names))
allprobs = allprobs[,c('id', label.names)]
write.table(allprobs, file='all_results_first5000.csv', quote=FALSE, sep=',', row.names=FALSE)
```


